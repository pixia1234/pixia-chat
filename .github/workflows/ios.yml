name: iOS CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build:
    runs-on: macos-14
    env:
      PROJECT: pixia-chat.xcodeproj
      SCHEME: PixiaChat
      BUNDLE_ID: euorg.pixiachat.pixia
      TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      PROFILE_NAME: ${{ secrets.IOS_PROFILE_NAME }}
      EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }}
      P12_BASE64: ${{ secrets.IOS_CERT_P12 }}
      P12_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
      PROFILE_BASE64: ${{ secrets.IOS_PROFILE_BASE64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          if [ -d /Applications/Xcode_15.4.app ]; then
            sudo xcode-select -s /Applications/Xcode_15.4.app
          else
            sudo xcode-select -s /Applications/Xcode.app
          fi
          xcodebuild -version

      - name: Ensure Core Data current version
        run: |
          python3 - <<'PY'
          import plistlib
          import pathlib
          import sys

          model_dir = pathlib.Path("pixia-chat/PixiaChat.xcdatamodeld")
          if not model_dir.is_dir():
              print(f"Missing {model_dir}")
              sys.exit(1)

          data = {"_XCCurrentVersionName": "PixiaChat.xcdatamodel"}
          (model_dir / ".xccurrentversion").write_bytes(
              plistlib.dumps(data, fmt=plistlib.FMT_BINARY)
          )
          PY

      - name: Build (Simulator)
        run: |
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination 'generic/platform=iOS Simulator' \
            -configuration Debug \
            build

      - name: Install signing certificate
        if: ${{ env.P12_BASE64 != '' && env.P12_PASSWORD != '' && env.PROFILE_BASE64 != '' && env.TEAM_ID != '' && env.PROFILE_NAME != '' }}
        run: |
          KEYCHAIN_PASSWORD=$(uuidgen)
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          echo "$P12_BASE64" | base64 --decode > cert.p12
          security import cert.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain

      - name: Install provisioning profile
        if: ${{ env.P12_BASE64 != '' && env.P12_PASSWORD != '' && env.PROFILE_BASE64 != '' && env.TEAM_ID != '' && env.PROFILE_NAME != '' }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Archive
        if: ${{ env.P12_BASE64 != '' && env.P12_PASSWORD != '' && env.PROFILE_BASE64 != '' && env.TEAM_ID != '' && env.PROFILE_NAME != '' }}
        run: |
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$PWD/build/PixiaChat.xcarchive" \
            -sdk iphoneos \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            clean archive

      - name: Export IPA
        if: ${{ env.P12_BASE64 != '' && env.P12_PASSWORD != '' && env.PROFILE_BASE64 != '' && env.TEAM_ID != '' && env.PROFILE_NAME != '' }}
        run: |
          mkdir -p build/export
          EXPORT_METHOD_VALUE=${EXPORT_METHOD:-ad-hoc}
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${EXPORT_METHOD_VALUE}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF
          xcodebuild \
            -exportArchive \
            -archivePath "$PWD/build/PixiaChat.xcarchive" \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath "$PWD/build/export"

      - name: Upload IPA
        if: ${{ env.P12_BASE64 != '' && env.P12_PASSWORD != '' && env.PROFILE_BASE64 != '' && env.TEAM_ID != '' && env.PROFILE_NAME != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: PixiaChat-ipa
          path: build/export/*.ipa
